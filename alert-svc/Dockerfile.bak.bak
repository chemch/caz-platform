# Use lightweight Alpine Python base image
FROM python:3.8-alpine

# Install system dependencies and pipenv
RUN apk update && apk add --no-cache gcc musl-dev libffi-dev bash && \
    pip install --no-cache-dir pipenv

# Set working directory
WORKDIR /usr/src/app

# Copy application code and bootstrap script
COPY Pipfile Pipfile.lock bootstrap.sh ./
COPY cashman ./cashman

# Ensure bootstrap.sh is executable
RUN chmod +x bootstrap.sh

# Install dependencies globally via Pipenv
RUN pipenv install --system --deploy

# Expose application port
EXPOSE 5008

# Use shell form to allow env variables and error propagation
ENTRYPOINT ["./bootstrap.sh"]
